<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×“××©×‘×•×¨×“ ×™×™×©×•×¨ ×©×™× ×™×™× ğŸ¦·</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen">
  
  <!-- Loader -->
  <div id="loader" class="fixed inset-0 bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 flex items-center justify-center z-50">
    <div class="text-center">
      <div class="animate-spin rounded-full h-16 w-16 border-4 border-purple-200 border-t-purple-600 mx-auto mb-4"></div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">ğŸ¦· ×˜×•×¢×Ÿ ××ª ×”× ×ª×•× ×™× ×©×œ×š...</h2>
      <p class="text-gray-600">×¨×’×¢ ×§×˜, ××›×™×Ÿ ××ª ×”×“×©×‘×•×¨×“</p>
    </div>
  </div>

  <!-- ×”×•×“×¢×ª ×©×’×™××” -->
  <div id="error" class="hidden max-w-7xl mx-auto p-6">
    <div class="bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg shadow-lg">
      <div class="flex items-center gap-3">
        <div class="text-2xl">âš ï¸</div>
        <div>
          <h3 class="font-bold text-lg mb-1">×©×’×™××”</h3>
          <p id="errorMessage"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- ×“××©×‘×•×¨×“ -->
  <div id="dashboard" class="max-w-7xl mx-auto p-6 relative hidden">
    <!-- ×›×¤×ª×•×¨×™× ×œ××¢×œ×” -->
    <div class="absolute top-6 right-6 flex gap-3 z-50">
      <button
        onclick="showReportForm()"
        class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-blue-600 transition-colors"
      >
        ğŸ“ ×“×™×•×•×— ×™×•××™
      </button>
      <button
        id="nextAlignerButton"
        onclick="advanceToNextAligner()"
        class="bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-green-600 transition-colors hidden"
      >
        â¡ï¸ ××¢×‘×¨ ×œ×§×©×ª×™×ª ×”×‘××”
      </button>
          </div>

    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">
        ğŸ¦· ××¡×¢ ×™×™×©×•×¨ ×”×©×™× ×™×™× ×©×œ×™ âœ¨
      </h1>
      <p class="text-gray-600">×¢×•×§×‘×ª ××—×¨×™ ×”×—×™×•×š ×”××•×©×œ×</p>
              </div>

    <!-- ×”×ª×¨××ª ×”×¦×œ×—×” -->
    <div id="successAlert" class="hidden bg-gradient-to-r from-green-400 to-emerald-500 text-white p-6 rounded-2xl shadow-lg mb-6">
      <div class="flex items-center gap-4">
        <div class="text-4xl">ğŸ†</div>
              <div>
          <h3 class="text-2xl font-bold">××–×œ ×˜×•×‘! ğŸ‰</h3>
          <p class="text-lg">×”×’×¢×ª ×œ×™×¢×“! ×–××Ÿ ×œ×¢×‘×•×¨ ×œ×§×©×ª×™×ª ×”×‘××”</p>
              </div>
            </div>
          </div>

    <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
      <div class="bg-white rounded-2xl p-6 shadow-lg border-2 border-purple-200">
        <div class="text-sm text-gray-600 mb-1">×§×©×ª×™×ª × ×•×›×—×™×ª</div>
        <div class="text-4xl font-bold text-purple-600" id="currentAligner">-</div>
        <div class="text-xs text-gray-500" id="totalAligners">××ª×•×š -</div>
              </div>

      <div class="bg-white rounded-2xl p-6 shadow-lg border-2 border-blue-200">
        <div class="text-sm text-gray-600 mb-1">×©×¢×•×ª ×©×¦×‘×¨×ª×™</div>
        <div class="text-4xl font-bold text-blue-600" id="hoursCompleted">-</div>
        <div class="text-xs text-gray-500">××ª×•×š 170 ×©×¢×•×ª</div>
              </div>

      <div class="bg-white rounded-2xl p-6 shadow-lg border-2 border-orange-200">
        <div class="text-sm text-gray-600 mb-1">×××•×¦×¢ ×©×¢×•×ª ×‘×™×•×</div>
        <div class="text-4xl font-bold text-orange-600" id="avgHours">-</div>
        <div class="text-xs text-gray-500">×§×¦×‘ ××¢×•×œ×”!</div>
          </div>

      <div class="bg-white rounded-2xl p-6 shadow-lg border-2 border-green-200">
        <div class="text-sm text-gray-600 mb-1">×™××™× ×‘×§×©×ª×™×ª</div>
        <div class="text-4xl font-bold text-green-600" id="daysElapsed">-</div>
        <div class="text-xs text-gray-500" id="estimatedDays">-</div>
          </div>
        </div>

    <!-- ×”×ª×§×“××•×ª ×‘×§×©×ª×™×ª -->
    <div class="bg-white rounded-2xl p-8 shadow-lg mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">
        ğŸ¯ ×”×ª×§×“××•×ª ×‘×§×©×ª×™×ª <span id="currentAlignerTitle">-</span>
          </h2>
          
      <div class="mb-4">
        <div class="flex justify-between text-sm mb-2">
          <span class="font-semibold text-gray-700" id="progressText">- / 170 ×©×¢×•×ª</span>
          <span class="font-bold text-purple-600" id="progressPercent">-%</span>
            </div>
        <div class="w-full bg-gray-200 rounded-full h-8 overflow-hidden">
          <div id="progressBar" class="h-full bg-gradient-to-r from-purple-400 via-purple-500 to-purple-600 transition-all duration-500 flex items-center justify-end px-3" style="width: 0%">
            <span class="text-white font-bold text-sm" id="progressBarText"></span>
              </div>
            </div>
          </div>

      <div id="progressMessage" class="bg-blue-50 rounded-xl p-4 mt-4"></div>
            </div>

    <!-- ××¤×ª ×§×©×ª×™×•×ª -->
    <div class="bg-white rounded-2xl p-8 shadow-lg mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">
        ğŸ—ºï¸ ××¤×ª ×”×§×©×ª×™×•×ª
      </h2>
      <div id="alignerMap" class="flex flex-wrap gap-3 mb-3"></div>
      <div class="flex justify-between mt-3 text-xs text-gray-600">
        <span class="flex items-center gap-1">
          <div class="w-3 h-3 bg-green-500 rounded"></div>
          ×”×•×©×œ×
        </span>
        <span class="flex items-center gap-1">
          <div class="w-3 h-3 bg-blue-500 rounded"></div>
          × ×•×›×—×™
        </span>
        <span class="flex items-center gap-1">
          <div class="w-3 h-3 bg-gray-200 rounded"></div>
          ×¢×ª×™×“×™
        </span>
            </div>
        </div>

    <!-- ×™×•××Ÿ -->
    <div class="bg-white rounded-2xl p-8 shadow-lg mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">
        ğŸ“… ×™×•××Ÿ ×©×¢×•×ª ××—×¨×•×Ÿ
          </h2>
      <div id="dailyLog" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-80 overflow-y-auto"></div>
    </div>

    <!-- ××•×˜×™×‘×¦×™×” -->
    <div class="bg-gradient-to-r from-pink-400 via-purple-400 to-indigo-400 text-white rounded-2xl p-8 shadow-lg text-center">
      <h3 class="text-2xl font-bold mb-3">×›×œ ×™×•× ××ª ×¦×•×¢×“×ª ×§×“×™××”! ğŸ’ª</h3>
      <p class="text-lg opacity-90">×”×—×™×•×š ×”××•×©×œ× ×©×œ×š ×××ª×™×Ÿ ×‘×¡×•×£ ×”××¡×¢ - ×”××©×™×›×™ ×›×š! ğŸŒŸ</p>
      <p class="text-sm opacity-75 mt-2" id="remainingAligners">-</p>
    </div>

    <!-- ×›×¤×ª×•×¨ ×¨×¢× ×•×Ÿ -->
    <div class="text-center mt-6">
      <button onclick="loadData()" class="bg-white text-purple-600 font-bold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl transition-all">
        ğŸ”„ ×¨×¢× ×Ÿ × ×ª×•× ×™×
      </button>
            </div>

    <!-- ×˜×•×¤×¡ ×“×™×•×•×— ×™×•××™ -->
    <div id="reportForm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold mb-4">×“×™×•×•×— ×™×•××™</h3>
        <form onsubmit="submitDailyReport(event)">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              ×ª××¨×™×š
            </label>
            <input
              type="date"
              id="reportDate"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            >
              </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              ××¡×¤×¨ ×§×©×ª×™×ª × ×•×›×—×™×ª
            </label>
            <div id="currentAlignerDisplay" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-700">
              ×˜×•×¢×Ÿ...
            </div>
          </div>
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              ×©×¢×•×ª ×”×™×•×
            </label>
            <input
              type="number"
              id="reportHours"
              min="0"
              max="24"
              step="0.5"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="×›××” ×©×¢×•×ª ×”×™×•×?"
              required
            >
          </div>
          <div class="flex gap-3">
            <button
              type="submit"
              id="submitButton"
              class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600"
            >
              ×©××•×¨
            </button>
            <button
              type="button"
              onclick="hideReportForm()"
              class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400"
            >
              ×‘×™×˜×•×œ
            </button>
                </div>
        </form>
            </div>
          </div>
        </div>

  <script>
    const CONFIG = {
      ALIGNERS_TABLE: 'tblxrDmKu22Emajqf',
      DAILY_LOG_TABLE: 'tblSf2uEre1fQJOjX',
      TOKEN: '{{AIRTABLE_TOKEN}}', // ×™×•×—×œ×£ ××•×˜×•××˜×™×ª ×¢×œ ×™×“×™ GitHub Actions ×‘×–××Ÿ build
      BASE_ID: 'appG0RNkEyiiETARE',
      // ×× ×™×© Cloudflare Worker proxy, ×”×’×“×¨ ××•×ª×• ×›××Ÿ:
      // PROXY_URL: 'https://YOUR-WORKER.workers.dev'
      PROXY_URL: null // null = ×œ× ×œ×”×©×ª××© ×‘-proxy
    };

    async function loadData() {
      const token = CONFIG.TOKEN;
      const baseId = CONFIG.BASE_ID;
      
      // ×‘×•×“×§ ×× ×”×˜×•×§×Ÿ ×¨×™×§
      if (!token || token.trim() === '') {
        showError('×× × ×”×–×™× ×™ API Token');
        return;
      }
      
      // ×œ×•×’ ×œ×“×™×‘×•×’
      console.log('ğŸ” Token check:', {
        hasToken: !!token,
        tokenLength: token ? token.length : 0,
        tokenStart: token ? token.substring(0, 10) : 'N/A',
        isPlaceholder: token === '{{AIRTABLE_TOKEN}}',
        tokenPreview: token && token.length > 20 ? token.substring(0, 20) + '...' : token
      });

      try {
        // ×˜×•×¢×Ÿ ×§×©×ª×™×•×ª
        const apiUrl = `https://api.airtable.com/v0/${baseId}/${CONFIG.ALIGNERS_TABLE}`;
        
        // ×× ×™×© proxy, ×”×©×ª××© ×‘×•
        const fetchUrl = CONFIG.PROXY_URL 
          ? `${CONFIG.PROXY_URL}?url=${encodeURIComponent(apiUrl)}`
          : apiUrl;
        
        const fetchOptions = CONFIG.PROXY_URL 
          ? {
              method: 'GET',
              mode: 'cors'
            }
          : {
              method: 'GET',
              mode: 'cors',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            };
        
        const alignersResponse = await fetch(fetchUrl, fetchOptions);

        if (!alignersResponse.ok) {
          const errorText = await alignersResponse.text();
          throw new Error(`×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×§×©×ª×™×•×ª (${alignersResponse.status}): ${errorText}`);
        }

        const alignersData = await alignersResponse.json();

        // ×˜×•×¢×Ÿ ×™×•××Ÿ
        const dailyApiUrl = `https://api.airtable.com/v0/${baseId}/${CONFIG.DAILY_LOG_TABLE}?sort[0][field]=×ª××¨×™×š&sort[0][direction]=desc`;
        
        // ×× ×™×© proxy, ×”×©×ª××© ×‘×•
        const dailyFetchUrl = CONFIG.PROXY_URL 
          ? `${CONFIG.PROXY_URL}?url=${encodeURIComponent(dailyApiUrl)}`
          : dailyApiUrl;
        
        const dailyFetchOptions = CONFIG.PROXY_URL 
          ? {
              method: 'GET',
              mode: 'cors'
            }
          : {
              method: 'GET',
              mode: 'cors',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            };
        
        const dailyResponse = await fetch(dailyFetchUrl, dailyFetchOptions);

        if (!dailyResponse.ok) {
          const errorText = await dailyResponse.text();
          throw new Error(`×©×’×™××” ×‘×˜×¢×™× ×ª ×™×•××Ÿ (${dailyResponse.status}): ${errorText}`);
        }

        const dailyData = await dailyResponse.json();

        // ××¢×‘×“ ×•××¦×™×’ × ×ª×•× ×™×
        displayData(alignersData.records, dailyData.records);

        // ××¡×ª×™×¨ ×”×•×“×¢×ª ×©×’×™××” ×•××¦×™×’ ×“××©×‘×•×¨×“
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('error').classList.add('hidden');

      } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×:', error);
        const errorMessage = error.message || 'Failed to fetch';
        showError(`×©×’×™××”: ${errorMessage}. ×‘×“×•×§ ××ª ×”×§×•× ×¡×•×œ ×œ×¤×¨×˜×™× × ×•×¡×¤×™×.`);
      }
    }

    function displayData(aligners, dailyLogs) {
      // ×”×¡×ª×¨ loader ×•×”×¦×’ ×“×©×‘×•×¨×“
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      
      // ××•×¦× ×§×©×ª×™×ª × ×•×›×—×™×ª
      const currentAligner = aligners.find(a => a.fields['×¡×˜×˜×•×¡'] === '×‘×©×™××•×© ×›×¢×ª âœ¨');
      
      if (!currentAligner) {
        showError('×œ× × ××¦××” ×§×©×ª×™×ª × ×•×›×—×™×ª');
        return;
      }

      const alignerNumber = currentAligner.fields['××¡×¤×¨ ×§×©×ª×™×ª'];
      const hoursCompleted = currentAligner.fields['×©×¢×•×ª ×©×©××ª×™'] || 0;
      const hoursRemaining = currentAligner.fields['×›××” ×©×¢×•×ª ×¢×•×“ ×—×¡×¨?'] || 170;
      const canAdvance = currentAligner.fields['××¤×©×¨ ×œ×¢×‘×•×¨ ×œ×”×‘××”?'] || false;
      
      // ×—×™×©×•×‘ ×™×¢×“ ×©×¢×•×ª ×›×•×œ×œ (×©×¢×•×ª ×©×”×•×©×œ××• + ×©×¢×•×ª ×©× ×•×ª×¨×•)
      const totalTargetHours = hoursCompleted + hoursRemaining;

      // ××—×©×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª
      const totalAligners = aligners.length;
      const currentLogs = dailyLogs.filter(log => 
        log.fields['××¡×¤×¨ ×§×©×ª×™×ª'] && 
        log.fields['××¡×¤×¨ ×§×©×ª×™×ª'].includes(currentAligner.id)
      );
      
      // ×—×™×©×•×‘ ××¡×¤×¨ ×™××™× ×™×™×—×•×“×™×™× (××’×¨×™×’×¦×™×” ×œ×¤×™ ×ª××¨×™×š)
      const uniqueDates = new Set();
      currentLogs.forEach(log => {
        if (log.fields['×ª××¨×™×š']) {
          uniqueDates.add(log.fields['×ª××¨×™×š']);
        }
      });
      const daysElapsed = uniqueDates.size;
      const avgHours = daysElapsed > 0 ? (hoursCompleted / daysElapsed).toFixed(1) : 0;
      const estimatedDays = hoursRemaining > 0 && avgHours > 0 
        ? Math.ceil(hoursRemaining / avgHours) 
        : 0;
      
      // ×—×™×©×•×‘ ××—×•×– ×”×ª×§×“××•×ª ×××™×ª×™
      const progressPercent = totalTargetHours > 0 ? Math.min((hoursCompleted / totalTargetHours) * 100, 100) : 0;
      
      // ×œ×•×’×™× ×œ×‘×“×™×§×”
      console.log('ğŸ” × ×ª×•× ×™ ×”×ª×§×“××•×ª:');
      console.log('- ×©×¢×•×ª ×©×”×•×©×œ××•:', hoursCompleted);
      console.log('- ×©×¢×•×ª ×©× ×•×ª×¨×•:', hoursRemaining);
      console.log('- ×™×¢×“ ×›×•×œ×œ:', totalTargetHours);
      console.log('- ××—×•×– ×”×ª×§×“××•×ª:', progressPercent);

      // ××¦×™×’ ×¡×˜×˜×™×¡×˜×™×§×•×ª
      document.getElementById('currentAligner').textContent = alignerNumber;
      document.getElementById('totalAligners').textContent = `××ª×•×š ${totalAligners} ×§×©×ª×™×•×ª`;
      document.getElementById('hoursCompleted').textContent = hoursCompleted;
      document.getElementById('avgHours').textContent = avgHours;
      document.getElementById('daysElapsed').textContent = daysElapsed;
      document.getElementById('estimatedDays').textContent = 
        estimatedDays > 0 ? `×¢×•×“ ${estimatedDays} ×™××™× ×œ×”×—×œ×¤×”` : '××•×›× ×” ×œ×”×—×œ×¤×”!';

      // ×”×ª×¨××ª ×”×¦×œ×—×” - ×¨×§ ×× ×‘×××ª ×”×’×¢×ª ×œ×™×¢×“
      if (canAdvance && hoursCompleted >= totalTargetHours) {
        document.getElementById('successAlert').classList.remove('hidden');
        const nextAlignerButton = document.getElementById('nextAlignerButton');
        nextAlignerButton.classList.remove('hidden');
        nextAlignerButton.textContent = `â¡ï¸ ××¢×‘×¨ ×œ×§×©×ª×™×ª ${parseInt(alignerNumber) + 1}`;
      } else {
        document.getElementById('successAlert').classList.add('hidden');
        document.getElementById('nextAlignerButton').classList.add('hidden');
      }

      // ×¤×¡ ×”×ª×§×“××•×ª
      document.getElementById('currentAlignerTitle').textContent = alignerNumber;
      document.getElementById('progressText').textContent = `${totalTargetHours} / ${hoursCompleted} ×©×¢×•×ª`;
      document.getElementById('progressPercent').textContent = `${progressPercent.toFixed(0)}%`;
      document.getElementById('progressBar').style.width = `${progressPercent}%`;
      
      if (progressPercent > 15) {
        document.getElementById('progressBarText').textContent = `${progressPercent.toFixed(0)}%`;
      }

      // ×”×•×“×¢×ª ×”×ª×§×“××•×ª
      const progressMsg = document.getElementById('progressMessage');
      if (hoursRemaining > 0) {
        progressMsg.className = 'bg-blue-50 rounded-xl p-4 mt-4';
        progressMsg.innerHTML = `
          <p class="text-blue-900 font-semibold">ğŸ’ª ×¢×•×“ ${hoursRemaining} ×©×¢×•×ª ×•×¢×•×‘×¨×™× ×œ×§×©×ª×™×ª ×”×‘××”!</p>
          <p class="text-blue-700 text-sm mt-1">×‘×§×¦×‘ ×”× ×•×›×—×™ ×©×œ ${avgHours} ×©×¢×•×ª ×‘×™×•× - ×¢×•×“ ×‘×¢×¨×š ${estimatedDays} ×™××™×</p>
        `;
      } else {
        progressMsg.className = 'bg-green-50 rounded-xl p-4 mt-4';
        progressMsg.innerHTML = `
          <p class="text-green-900 font-semibold">âœ… ×”×’×¢×ª ×œ×™×¢×“! ×–××Ÿ ×œ×¢×‘×•×¨ ×œ×§×©×ª×™×ª ${alignerNumber + 1}</p>
        `;
      }

      // ××¤×ª ×§×©×ª×™×•×ª - ×¨×©×ª ×©×œ ×¨×™×‘×•×¢×™×
      const mapHtml = aligners
        .sort((a, b) => a.fields['××¡×¤×¨ ×§×©×ª×™×ª'] - b.fields['××¡×¤×¨ ×§×©×ª×™×ª'])
        .map(aligner => {
          const num = aligner.fields['××¡×¤×¨ ×§×©×ª×™×ª'];
          const status = aligner.fields['×¡×˜×˜×•×¡'];
          let className = 'w-12 h-12 rounded-lg flex items-center justify-center text-xs font-bold transition-all ';
          
          if (status === '×”×•×©×œ×! âœ“') {
            className += 'bg-green-500 text-white';
          } else if (status === '×‘×©×™××•×© ×›×¢×ª âœ¨') {
            className += 'bg-blue-500 text-white ring-4 ring-blue-300';
          } else {
            className += 'bg-gray-200 text-gray-500';
          }
          
          return `<div class="${className}">${num}</div>`;
        })
        .join('');
      
      document.getElementById('alignerMap').innerHTML = mapHtml;

      // ×™×•××Ÿ
      const logHtml = dailyLogs.slice(0, 21).map(log => {
        const date = log.fields['×ª××¨×™×š'] || '-';
        const hours = log.fields['×©×¢×•×ª ×©×™××•×© ×”×™×•×'] || 0;
        
        return `
          <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
            <div class="flex items-center justify-between mb-2">
              <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white text-sm bg-green-500">
                ${hours}
              </div>
            </div>
            <p class="text-xs font-medium text-gray-700 truncate">${date}</p>
            <p class="text-xs text-gray-500">${hours} ×©×¢×•×ª</p>
          </div>
        `;
      }).join('');
      
      document.getElementById('dailyLog').innerHTML = logHtml;

      // ××•×˜×™×‘×¦×™×”
      document.getElementById('remainingAligners').textContent = 
        `×¢×•×“ ${totalAligners - alignerNumber} ×§×©×ª×™×•×ª ×•××ª ×©×!`;
    }

    function showError(message) {
      // ×”×¡×ª×¨ loader ×•×”×¦×’ ×”×•×“×¢×ª ×©×’×™××”
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      
      const errorDiv = document.getElementById('error');
      const errorMessage = document.getElementById('errorMessage');
      if (errorMessage) {
        errorMessage.textContent = message;
      }
      errorDiv.classList.remove('hidden');
    }

    // ×¤×•× ×§×¦×™×•×ª ×œ×˜×•×¤×¡ ×“×™×•×•×— ×™×•××™
    async function showReportForm() {
      const form = document.getElementById('reportForm');
      const dateInput = document.getElementById('reportDate');
      const alignerDisplay = document.getElementById('currentAlignerDisplay');
      
      // ×”×’×“×¨×ª ×ª××¨×™×š ×”×™×•× ×›×‘×¨×™×¨×ª ××—×“×œ
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
      
      // ×§×‘×œ×ª ××¡×¤×¨ ×”×§×©×ª×™×ª ×”× ×•×›×—×™×ª
      try {
        const token = CONFIG.TOKEN;
        const baseId = CONFIG.BASE_ID;
        
        const alignersResponse = await fetch(
          `https://api.airtable.com/v0/${baseId}/${CONFIG.ALIGNERS_TABLE}`,
          {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          }
        );
        
        const alignersData = await alignersResponse.json();
        const currentAligner = alignersData.records.find(a => a.fields['×¡×˜×˜×•×¡'] === '×‘×©×™××•×© ×›×¢×ª âœ¨');
        
        if (currentAligner) {
          alignerDisplay.textContent = `×§×©×ª×™×ª ${currentAligner.fields['××¡×¤×¨ ×§×©×ª×™×ª']}`;
        } else {
          alignerDisplay.textContent = '×œ× × ××¦××” ×§×©×ª×™×ª × ×•×›×—×™×ª';
        }
      } catch (error) {
        alignerDisplay.textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×';
      }
      
      form.classList.remove('hidden');
    }

    function hideReportForm() {
      document.getElementById('reportForm').classList.add('hidden');
      // ××™×¤×•×¡ ×”×˜×•×¤×¡
      document.getElementById('reportDate').value = '';
      document.getElementById('reportHours').value = '';
      document.getElementById('currentAlignerDisplay').textContent = '×˜×•×¢×Ÿ...';
    }

    async function submitDailyReport(event) {
      event.preventDefault();
      
      const submitButton = document.getElementById('submitButton');
      const originalText = submitButton.textContent;
      
      try {
        // ××¦×‘ ×˜×¢×™× ×”
        submitButton.textContent = '×©×•××¨...';
        submitButton.disabled = true;
        
        const token = CONFIG.TOKEN;
        const baseId = CONFIG.BASE_ID;
        const date = document.getElementById('reportDate').value;
        const hours = parseFloat(document.getElementById('reportHours').value);
        
        // ×§×‘×œ×ª ×”×§×©×ª×™×ª ×”× ×•×›×—×™×ª
        const alignersResponse = await fetch(
          `https://api.airtable.com/v0/${baseId}/${CONFIG.ALIGNERS_TABLE}`,
          {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          }
        );
        
        const alignersData = await alignersResponse.json();
        const currentAligner = alignersData.records.find(a => a.fields['×¡×˜×˜×•×¡'] === '×‘×©×™××•×© ×›×¢×ª âœ¨');
        
        if (!currentAligner) {
          throw new Error('×œ× × ××¦××” ×§×©×ª×™×ª × ×•×›×—×™×ª');
        }
        
        // ×©×œ×™×—×” ×œ-Airtable ×¢× ×§×™×©×•×¨ ×œ×§×©×ª×™×ª
        const response = await fetch(
          `https://api.airtable.com/v0/${baseId}/${CONFIG.DAILY_LOG_TABLE}`,
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              fields: {
                '×ª××¨×™×š': date,
                '×©×¢×•×ª ×©×™××•×© ×”×™×•×': hours,
                '××¡×¤×¨ ×§×©×ª×™×ª': [currentAligner.id], // ×§×™×©×•×¨ ×œ×§×©×ª×™×ª ×”× ×•×›×—×™×ª
              }
            })
          }
        );
        
        if (response.ok) {
          // ×¡×’×™×¨×ª ×”×˜×•×¤×¡ ×•×¨×¢× ×•×Ÿ ×”× ×ª×•× ×™×
          hideReportForm();
          loadData(); // ×¨×¢× ×•×Ÿ ×”×“××©×‘×•×¨×“
        } else {
          throw new Error('×©×’×™××” ×‘×©××™×¨×ª ×”×“×™×•×•×—');
        }
        
      } catch (error) {
        showError('×©×’×™××” ×‘×©××™×¨×ª ×”×“×™×•×•×—: ' + error.message);
      } finally {
        // ×”×—×–×¨×ª ×”××¦×‘ ×”×¨×’×™×œ
        submitButton.textContent = originalText;
        submitButton.disabled = false;
      }
    }

    // ×¤×•× ×§×¦×™×” ×œ××¢×‘×¨ ×œ×§×©×ª×™×ª ×”×‘××”
    async function advanceToNextAligner() {
      console.log('ğŸš€ ××ª×—×™×œ ××¢×‘×¨ ×œ×§×©×ª×™×ª ×”×‘××”...');
      const token = CONFIG.TOKEN;
      const baseId = CONFIG.BASE_ID;
      
      try {
        console.log('ğŸ“¡ ×˜×•×¢×Ÿ × ×ª×•× ×™ ×§×©×ª×™×•×ª...');
        // ×§×‘×œ×ª ×”×§×©×ª×™×ª ×”× ×•×›×—×™×ª
        const alignersResponse = await fetch(
          `https://api.airtable.com/v0/${baseId}/${CONFIG.ALIGNERS_TABLE}`,
          {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          }
        );
        
        if (!alignersResponse.ok) {
          throw new Error(`×©×’×™××” ×‘×˜×¢×™× ×ª ×§×©×ª×™×•×ª: ${alignersResponse.status}`);
        }
        
        const alignersData = await alignersResponse.json();
        console.log('ğŸ“Š × ×ª×•× ×™ ×§×©×ª×™×•×ª:', alignersData);
        
        const currentAligner = alignersData.records.find(a => a.fields['×¡×˜×˜×•×¡'] === '×‘×©×™××•×© ×›×¢×ª âœ¨');
        console.log('ğŸ¯ ×§×©×ª×™×ª × ×•×›×—×™×ª:', currentAligner);
        
        if (!currentAligner) {
          throw new Error('×œ× × ××¦××” ×§×©×ª×™×ª × ×•×›×—×™×ª');
        }
        
        const nextAlignerNumber = currentAligner.fields['××¡×¤×¨ ×§×©×ª×™×ª'] + 1;
        const nextAligner = alignersData.records.find(a => a.fields['××¡×¤×¨ ×§×©×ª×™×ª'] === nextAlignerNumber);
        console.log('â¡ï¸ ×§×©×ª×™×ª ×”×‘××”:', nextAligner);
        
        if (!nextAligner) {
          alert('×–×• ×”×§×©×ª×™×ª ×”××—×¨×•× ×”!');
          return;
        }
        
        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”×§×©×ª×™×ª ×”× ×•×›×—×™×ª ×œ"×”×•×©×œ×"
        console.log(`ğŸ”„ ××¢×“×›×Ÿ ×§×©×ª×™×ª ${currentAligner.fields['××¡×¤×¨ ×§×©×ª×™×ª']} ×œ"×”×•×©×œ×"...`);
        const currentAlignerResponse = await fetch(
          `https://api.airtable.com/v0/${baseId}/${CONFIG.ALIGNERS_TABLE}/${currentAligner.id}`,
          {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              fields: {
                '×¡×˜×˜×•×¡': '×”×•×©×œ×! âœ“'
              }
            })
          }
        );
        
        console.log('ğŸ“ ×ª×’×•×‘×ª ×¢×“×›×•×Ÿ ×§×©×ª×™×ª × ×•×›×—×™×ª:', currentAlignerResponse.status);
        
        if (!currentAlignerResponse.ok) {
          const errorText = await currentAlignerResponse.text();
          throw new Error(`×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”×§×©×ª×™×ª ×”× ×•×›×—×™×ª: ${errorText}`);
        }
        
        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”×§×©×ª×™×ª ×”×‘××” ×œ"×‘×©×™××•×© ×›×¢×ª"
        console.log(`ğŸ”„ ××¢×“×›×Ÿ ×§×©×ª×™×ª ${nextAligner.fields['××¡×¤×¨ ×§×©×ª×™×ª']} ×œ"×‘×©×™××•×© ×›×¢×ª"...`);
        const nextAlignerResponse = await fetch(
          `https://api.airtable.com/v0/${baseId}/${CONFIG.ALIGNERS_TABLE}/${nextAligner.id}`,
          {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              fields: {
                '×¡×˜×˜×•×¡': '×‘×©×™××•×© ×›×¢×ª âœ¨',
              }
            })
          }
        );
        
        console.log('ğŸ“ ×ª×’×•×‘×ª ×¢×“×›×•×Ÿ ×§×©×ª×™×ª ×”×‘××”:', nextAlignerResponse.status);
        
        if (!nextAlignerResponse.ok) {
          const errorText = await nextAlignerResponse.text();
          throw new Error(`×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”×§×©×ª×™×ª ×”×‘××”: ${errorText}`);
        }
        
        console.log('âœ… ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡×™× ×”×•×©×œ× ×‘×”×¦×œ×—×”');
        
        // ×¨×¢× ×•×Ÿ ×”×“××©×‘×•×¨×“
        console.log('ğŸ”„ ××¨×¢× ×Ÿ ×“××©×‘×•×¨×“...');
        await loadData();
        console.log('âœ… ×“××©×‘×•×¨×“ ×¨×•×¢× ×Ÿ ×‘×”×¦×œ×—×”');
        
        // ×”×•×“×¢×ª ×”×¦×œ×—×”
        alert(`×¢×‘×¨×ª ×‘×”×¦×œ×—×” ×œ×§×©×ª×™×ª ${nextAligner.fields['××¡×¤×¨ ×§×©×ª×™×ª']}! ğŸ‰`);
        
      } catch (error) {
        console.error('âŒ ×©×’×™××” ×‘××¢×‘×¨ ×œ×§×©×ª×™×ª ×”×‘××”:', error);
        showError('×©×’×™××” ×‘××¢×‘×¨ ×œ×§×©×ª×™×ª ×”×‘××”: ' + error.message);
      }
    }

    // ×˜×¢×Ÿ × ×ª×•× ×™× ××•×˜×•××˜×™×ª ×¢× ×˜×¢×™× ×ª ×”×¢××•×“
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
    });
  </script>

</body>
</html>